# Типы пакетов

Этот документ перечисляет все форматы пакетов, которые использует прошивка. Список помогает расставить приоритеты при разработке и тестировании.

## Обзор

| Тип | Формат/маркировка | Где формируется | Назначение и особенности |
|-----|-------------------|-----------------|--------------------------|
| Пользовательские кадры | Заголовок `FrameHeader` + полезная нагрузка, опционально с префиксом `[TAG|i/n]` | `TxModule` / `PacketSplitter` | Основной тип сообщений. Фрагменты отмечаются префиксом `[TAG|i/n]`, последняя часть (`i = n`) собирается в `PacketGatherer` и попадает в `ReceivedBuffer` как `SP-xxxxx` и `GO-xxxxx`. Поддерживают шифрование, код Рида–Соломона, интерливинг и ACK. |
| RAW-вставки | Имя в `ReceivedBuffer` `R-000000|part` | `RxModule` | Сырые кадры или одиночные байты, для которых не удалось восстановить заголовок. Передаются напрямую в пользовательский колбэк и, при активном буфере, сохраняются как `Kind::Raw`. Не декодируются и не участвуют в сборке сообщений. |
| Сборочные сегменты | `SP-xxxxx` | `RxModule` / `PacketGatherer` | Промежуточные данные при сборке многофрагментных сообщений. Сохраняются в `ReceivedBuffer` и помогают отслеживать прогресс. |
| Готовые сообщения | `GO-xxxxx` | `RxModule` | Финальные собранные сообщения. Передаются в пользовательский колбэк и добавляются в `ReceivedBuffer` как `Kind::Ready`. |
| ACK | Однобайтовый маркер `0x06` (также распознаётся строка `"ACK"` с префиксом) | `TxModule` | Подтверждение доставки. Использует отдельную очередь и диапазон `msg_id >= 0x80000000`. Структура описана в отдельном документе. |
| Пинг | 5 байт: `id_lo`, `id_hi`, `id_lo^id_hi`, `0`, `0` | `serial_radio_control.ino` / `RadioSX1262::ping` | Проверка связи и измерение задержки. Ответ должен совпадать с отправленным буфером. |
| Маяк (Beacon) | 15 байт: заголовок с XOR-идентификатором + ASCII `"BEACON"` | `RadioSX1262::sendBeacon` | Служебный широковещательный пакет с подписью. Используется командой `BCN`. |
| KEYTRANSFER | Защищённый кадр с публичным ключом | `KeyTransfer::buildFrame` | Обмен корневыми ключами по LoRa. Использует AES-CCM, вставки пилотов и статический корневой ключ. Начиная с версии 2 кадр дополнительно содержит эпемерный публичный ключ X25519, а версия 3 добавляет цепочку сертификатов Ed25519. Расшифровка выполняется `KeyTransfer::parseFrame`. |
| Legacy тест (SendMsg_BR) | 112 байт: исторический формат с псевдослучайным ID | `testModeProcessMessage` | Эмуляция старого протокола для режима `TESTRXM`. Используется только в тестовом режиме, данные добавляются в `ReceivedBuffer`. |

## Детали

### Пользовательские кадры
- `TxModule` формирует кадры на основе заголовка `FrameHeader`, может включать шифрование AES-CCM, свёрточное кодирование и интерливинг.
- `PacketSplitter` добавляет префиксы `[TAG|i/n]` к многочастным сообщениям, а `PacketGatherer` собирает их обратно. Идентификатор `TAG` генерируется монотонным счётчиком и сериализуется как восемь шестнадцатеричных символов, что исключает повторы в рамках сессии. Финальный результат передаётся в буфер принятых сообщений (`SP-xxxxx` → `GO-xxxxx`).

### RAW, SP, GO в `ReceivedBuffer`
- `ReceivedBuffer` выделяет три очереди (`Raw`, `Split`, `Ready`) и автоматически генерирует имена `R-000000|part`, `SP-xxxxx`, `GO-xxxxx`.
- Режим RAW в `RxModule` активируется для слишком коротких пакетов и кадров с ошибками заголовка; такие элементы не декодируются и не участвуют в сборке.

### ACK
- ACK-кадр содержит минимальный заголовок `FrameHeader` с `frag_cnt = 1` и полезную нагрузку `0x06`. Дополнительно поддерживается текстовый вариант `"ACK"` (возможно с префиксом `[TAG|N]`).
- Подробная структура и порядок обработки описаны в `docs/ack_packet_structure.md`.

### Пинг
- Команда `PI` из Serial и HTTP формирует буфер из пяти байтов, отправляет его через `RadioSX1262::ping` и ожидает идентичный ответ.
- Параметры ожидания задаются `DefaultSettings::PING_WAIT_MS` и `PING_PACKET_SIZE`.

### Маяк
- `RadioSX1262::sendBeacon()` формирует пакет длиной 15 байт: два случайных байта, их XOR и текст `"BEACON"` в хвосте. Кнопка `BCN` в веб-интерфейсе и Serial-команда вызывают эту функцию.

### KEYTRANSFER
- `KeyTransfer::buildFrame()` собирает защищённый кадр с публичным ключом, используя статический корневой ключ AES-CCM и добавляя пилоты каждые 64 байта. Поддерживаются кадры версии 1 (только долговременный ключ), версии 2 (дополнительно упаковывается эпемерный публичный ключ X25519) и версии 3 (содержит цепочку сертификатов Ed25519 и, при необходимости, эпемерный ключ).
- `KeyTransfer::parseFrame()` обратным образом удаляет пилоты, проверяет CRC кадра и расшифровывает содержимое, возвращая структуру `FramePayload` с версией, флагами, цепочкой сертификатов и, при наличии, эпемерным ключом.

### Legacy тестовый пакет
- Режим `TESTRXM` формирует исторические пакеты `SendMsg_BR` из 112 байт с псевдослучайным идентификатором и полезной нагрузкой до 96 байт.
- Пакеты используются только для эмуляции входящих сообщений в тестовом режиме и не отправляются по радио вне теста.
