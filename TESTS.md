# Тесты для ESP32 LoRa Pipeline с веб‑интерфейсом

Этот документ описывает набор ручных тестов, которые позволяют убедиться, что веб‑интерфейс корректно работает и управляет LoRa‑параметрами. Перед выполнением тестов прошейте устройство прошивкой из архива и подключитесь к Wi‑Fi точки доступа, созданной устройством (по умолчанию `ESP32-LoRa`/`12345678`). Откройте в браузере страницу `http://192.168.4.1/`.

## Тестирование обмена сообщениями

1. В поле ввода «Enter message» наберите текст (например, `Hello`), нажмите кнопку **Send**.
2. Убедитесь, что в чате появилась строка `*TX:* Hello`. Если устройство подключено к другому модулю, сообщение должно быть доставлено, а в чате появится соответствующий приём `*RX:* …`.

## Проверка переключения банка и пресета

1. В выпадающем списке **Bank** выберите, например, `RESERVE`. Наблюдайте сообщение в чате `*SYS:* Bank set to 1`.
2. В списке **Preset** выберите другой номер. В чате должна появиться строка `*SYS:* Preset set to …`.
3. Смените обратно на `MAIN` и убедитесь, что частоты приёма/передачи возвращаются к исходным (сообщение выводится в консоль `Serial`, но можно проверить по обмену).

## Тестирование параметров LoRa

1. В списках **BW**, **SF**, **CR** и **TXP** выберите новые значения. Каждое изменение сопровождается сообщением `*SYS:* BW set to …`, `*SYS:* SF set to …` и т.д.
2. Наблюдайте, что связь сохраняется и сообщения отправляются/принимаются после изменения параметров.

## Тестирование ACK и повторов

1. Отметьте чекбокс **Ack**. В чате появится `*SYS:* ACK=ON`. Посмотрите на поведение отправки: при потерянных кадрах сообщения будут автоматически повторяться до указанного числа повторов.
2. В поле **RetryN** укажите 3. В чате появится `*SYS:* RETRYN set to 3`. Аналогично измените **RetryMS**, например, на 500, и убедитесь, что пауза между повторами увеличилась.
3. Снимите чекбокс **Ack** и убедитесь, что повторов больше нет, а в чате появится `*SYS:* ACK=OFF`.

## Тестирование шифрования

1. Установите KID, например `2`, нажав Enter. В чате появится сообщение `*SYS:* KID set to 2`.
2. В поле **KEY** введите 32‑символьную строку из шестнадцатеричных символов (например, `00112233445566778899aabbccddeeff`) и нажмите **Load Key**. В чате должно появиться `*SYS:* Key loaded for KID 2`.
3. Включите чекбокс **Enc**. Отправленные сообщения теперь шифруются (для проверки используйте второй модуль с той же конфигурацией ключа).
4. Выключите **Enc**, убедитесь, что сообщения вновь передаются в открытом виде.

## Тестирование команд Ping и Metrics

1. Нажмите **Ping**. Интерфейс сразу вернёт `*SYS:* Ping started`. Через ~1–1.5 с (при большой задержке связи) добавится строка `*SYS:* RX:…/TX:…` с текущими частотами, затем либо `*SYS:* Ping>OK RSSI:… dBm/SNR:… dB distance:~… km time:… ms`, либо сообщение об ошибке (`CRC error!`), либо `*SYS:* Ping timeout`. Асинхронный режим позволяет веб‑интерфейсу оставаться отзывчивым даже при больших задержках — пинг выполняется в фоне без блокировок. После завершения радио возвращается к приёму.
2. Нажмите **Metrics** — внизу страницы обновится текст со статистикой отправленных/принятых кадров и ошибок. В чате появится `*SYS:* Metrics requested`.

## Сохранение, загрузка и сброс настроек

1. Измените несколько параметров (например, BW и TXP), затем нажмите **Save**. В чате будет сообщение `*SYS:* Config saved`.
2. Перезагрузите устройство или нажмите **Load** — параметры должны восстановиться из памяти NVS (в чате появится `*SYS:* Config loaded`).
3. Нажмите **Reset** — все сохранённые параметры будут удалены (`*SYS:* Config reset`) и устройства вернётся к значениям по умолчанию.

## Очистка чата

Для очистки чата достаточно обновить страницу в браузере. Буфер `serialBuffer` передаётся клиенту и очищается при каждом опросе `/serial`, поэтому сообщения не дублируются между обновлениями.