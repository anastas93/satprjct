# Минимальный модуль передачи и приёма

В форке оставлены только базовые компоненты:

- `MessageBuffer` — простой буфер сообщений с ограничением по размеру.
- `PacketSplitter` — делитель пакетов с тремя режимами размера полезной нагрузки.
- `PacketGatherer` — собиратель пакетов обратно в сообщение.
- `TxModule` — передача данных через интерфейс `IRadio`.
- `RxModule` — приём данных и передача их в пользовательский колбэк.
- `FrameHeader` — заголовок кадра с функциями `encode()` и `decode()`.
- `IRadio` описан в `radio_interface.h`.
- `RadioSX1262` — конкретная реализация интерфейса на базе модуля SX1262.
- `SerialProgramCollector` — библиотека для приёма строк по Serial и сборки их в один буфер (`libs/serial_program_collector/`).
  - `serial_radio_control.ino` — пример настройки банков каналов, BW, SF, CR и мощности через Serial, вывода текущих параметров и отправки тестовых пакетов через `TxModule`.
- `TextConverter` — библиотека (`libs/text_converter/`) для преобразования UTF-8 текста в байты CP1251, используемая командой `TX`.
- Для отладочных сообщений предусмотрен флаг `DefaultSettings::DEBUG` и уровни журналирования `DefaultSettings::LOG_LEVEL`. Доступны макросы `LOG_ERROR`, `LOG_WARN`, `LOG_INFO`, `DEBUG_LOG` и их варианты с выводом значения (`*_VAL`) для фильтрации лишнего спама.

Все сторонние библиотеки расположены в каталоге `libs/`.
Для корректной сборки в Arduino добавлен вспомогательный файл `libs_includes.cpp`,
который явно подключает реализации библиотек.

## API
### MessageBuffer
- `MessageBuffer(size_t capacity)` — создать буфер с максимальным количеством сообщений.
- `uint32_t enqueue(const uint8_t* data, size_t len)` — добавляет сообщение в буфер, при переполнении возвращает `0`.
- `size_t freeSlots() const` — получить число свободных слотов в очереди.
- `bool dropLast()` — удалить последнее сообщение (используется для отката).
- `bool hasPending() const` — проверяет наличие сообщений.
- `bool pop(uint32_t& id, std::vector<uint8_t>& out)` — извлекает сообщение и его идентификатор.

### PacketSplitter
- `PacketSplitter(PayloadMode mode)` — создать делитель с выбранным режимом (`SMALL`, `MEDIUM`, `LARGE`).
- `void setMode(PayloadMode mode)` — сменить режим.
- `uint32_t splitAndEnqueue(MessageBuffer& buf, const uint8_t* data, size_t len)` — разбить данные на части и занести их в буфер с предварительной проверкой свободных слотов и откатом при ошибке.

### PacketGatherer
- `PacketGatherer(PayloadMode mode)` — создать собиратель.
- `void reset()` — сбросить накопленные данные.
- `void add(const uint8_t* data, size_t len)` — добавить очередную часть.
- `bool isComplete() const` — проверить завершение сбора.
- `const std::vector<uint8_t>& get() const` — получить готовое сообщение.

### FrameHeader
- `bool encode(uint8_t* out, size_t out_len, const uint8_t* payload, size_t payload_len)` — записать заголовок в буфер и подсчитать CRC.
- `static bool decode(const uint8_t* data, size_t len, FrameHeader& out)` — разобрать заголовок из буфера и проверить CRC.

### TxModule
- `TxModule(IRadio& radio, const std::array<size_t,4>& capacities, PayloadMode mode)` — инициализация модуля с четырьмя очередями QoS.
- `void setPayloadMode(PayloadMode mode)` — сменить режим размера пакета.
- `uint32_t queue(const uint8_t* data, size_t len, uint8_t qos = 0)` — поместить сообщение в очередь выбранного класса QoS.
- `void loop()` — отправить первое сообщение, если оно есть.
- `void setSendPause(uint32_t pause_ms)` — задать паузу между отправками в миллисекундах.

### RxModule
- `void setCallback(RxModule::Callback cb)` — установить обработчик входящих данных.
- `void onReceive(const uint8_t* data, size_t len)` — принять кадр, проверить CRC и передать полезные данные обработчику.

### RadioSX1262
  - `bool begin()` — инициализация радиомодуля с автоматическим возвратом параметров к значениям по умолчанию.
- `void send(const uint8_t* data, size_t len)` — отправка пакета.
- `void loop()` — обработка готовности пакета и вызов колбэка в основном цикле.
- `void setReceiveCallback(IRadio::RxCallback cb)` — регистрация обработчика приёма.
- `bool setBank(ChannelBank bank)` — выбрать банк каналов (`EAST`, `WEST`, `TEST`).
- `bool setChannel(uint8_t ch)` — выбрать номер канала 0…9 и установить частоту приёма.
- `bool setBandwidth(float bw)` — задать ширину полосы в кГц.
- `bool setSpreadingFactor(int sf)` — указать фактор расширения 5…12.
- `bool setCodingRate(int cr)` — задать коэффициент кодирования 5…8.
- `bool setPower(uint8_t preset)` — установить уровень мощности из таблицы (-5…22 дБм).
- `void sendBeacon()` — отправить служебный пакет-маяк.
- `ChannelBank getBank() const`, `uint8_t getChannel() const`, `float getBandwidth() const`, `int getSpreadingFactor() const`, `int getCodingRate() const`, `int getPower() const`, `float getRxFrequency() const`, `float getTxFrequency() const` — получить текущие параметры.
  - `bool resetToDefaults()` — вернуть параметры радиомодуля к значениям по умолчанию.
  - Значения параметров по умолчанию заданы в файле `default_settings.h`.

### SerialProgramCollector
- `void resetBuffer()` — очистить буфер и начать новый сбор.
- `bool appendToBuffer(const String& line)` — добавить строку в общий буфер с проверкой переполнения.

### TextConverter
- `std::vector<uint8_t> utf8ToCp1251(const std::string& in)` — преобразует UTF-8 строку в байты CP1251.

## Что реализовано
- Базовая отправка и приём сообщений.
- Очереди сообщений по классам QoS с приоритетной обработкой.
- Делитель и собиратель пакетов с тремя режимами размера payload.
- Реализована настройка радиомодуля SX1262 и методы отправки/приёма.
- Обработка входящих пакетов через флаг `packetReady` и метод `loop()`.
- Приём строк по Serial и объединение их в буфер до 500 КБ.
- Добавлен заголовок кадра с контролем CRC и вставкой пилотов при передаче.
- Настройка полосы, фактора расширения, коэффициента кодирования и банка каналов с разнесением частот приёма и передачи через Serial.
- Тестовая отправка пакета через Serial с автоматическим переключением частоты TX.
- Настройка паузы между отправками пакетов в TxModule.
- Проверка максимального размера кадра перед отправкой (255 байт).
- Сброс параметров радиомодуля к значениям по умолчанию.
- Автоматическая установка этих параметров при запуске.
- Настройка мощности и команда INFO для отображения текущих параметров.
- Отправка служебного маяка для поиска устройств.
- Конвертация UTF-8 текста в CP1251 для команды TX.
- Файл `default_settings.h` с параметрами радиомодуля по умолчанию.
- Базовые тесты для буфера сообщений, делителя пакетов и формирования кадров.

## Что осталось сделать
  - Расширить управление радиомодулем (массовый пинг и т.д.).
  - Добавить подтверждения, шифрование и кодирование ошибок.
  - Реализовать обработку пилотов в RxPipeline (`updatePhaseFromPilot`).
  - Вернуть расширенные возможности исходного проекта по мере необходимости.
  - Уточнить формат пакетов (нумерация частей, контроль целостности) для надёжной сборки.
  - Добавить сохранение собранной программы и расширенную обработку команд завершения.
  - Покрыть тестами приём и обработку пилотов.
  - Реализовать поддержку других кодировок и символов в конвертере текста.
  - Внедрить планировщик WFQ для классов QoS.
  - Реализовать разделение кадра при превышении лимита размера.

